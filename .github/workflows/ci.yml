name: CI

on:
  push:
    branches: [ "main", "develop" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main", "develop" ]

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-test:
    name: Build & Test (QGIS + ActiveMQ)
    runs-on: ubuntu-24.04
    # Привязываем к окружению 'ci' (настройки в UI не требуются)
    environment: ci

    env:
      QT_QPA_PLATFORM: offscreen
      DISPLAY: ":99"
      QGIS_PREFIX_PATH: /usr
      PYTHONPATH: /usr/share/qgis/python
      QGIS_PROVIDER_FILE: /usr/lib/qgis/plugins

    services:
      activemq:
        image: rmohr/activemq:5.16.5
        ports:
          - 61616:61616
          - 8161:8161
        options: >-
          --health-cmd="curl -f http://localhost:8161 || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install QGIS LTR (Ubuntu 24.04 noble)
        shell: bash
        run: |
          set -euxo pipefail
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends ca-certificates gnupg curl wget zip
          . /etc/os-release
          sudo mkdir -p /etc/apt/keyrings
          curl -fsSL https://download.qgis.org/downloads/qgis-archive-keyring.gpg -o /tmp/qgis-archive-keyring.gpg
          sudo mv /tmp/qgis-archive-keyring.gpg /etc/apt/keyrings/qgis-archive-keyring.gpg
          echo "deb [signed-by=/etc/apt/keyrings/qgis-archive-keyring.gpg] https://qgis.org/ubuntu-ltr ${UBUNTU_CODENAME} main" | sudo tee /etc/apt/sources.list.d/qgis-ltr.list
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends qgis qgis-python python3-qgis python3-pip xvfb
          python3 -m pip install --upgrade pip
          python3 -m pip install pytest pytest-xdist requests paho-mqtt

      - name: Start Xvfb (headless GUI)
        run: nohup Xvfb :99 -screen 0 1920x1080x24 >/tmp/xvfb.log 2>&1 &

      - name: Smoke test (QGIS import)
        shell: bash
        run: |
          python3 - <<'PY'
          import os, sys
          os.environ.setdefault("QT_QPA_PLATFORM","offscreen")
          from qgis.core import QgsApplication
          print("QGIS core import OK")
          PY

      - name: Package plugin (zip)
        if: startsWith(github.ref, 'refs/tags/v')
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p dist
          name="$(basename "$GITHUB_WORKSPACE")"
          cd ..
          zip -r "$GITHUB_WORKSPACE/dist/poiskmore_plugin.zip" "$name" \
            -x "$name/.git/**" "$name/.github/**" "$name/__pycache__/**" \
               "$name/.devcontainer/**" "$name/.vscode/**" "$name/docker/**" \
               "$name/docker-compose.*" "$name/docs/**" "$name/scripts/**" \
               "$name/codex/**" "$name/*.md"

      - name: Upload artifact
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-artifact@v4
        with:
          name: poiskmore_plugin
          path: dist/poiskmore_plugin.zip
          retention-days: 7

  release:
    name: Release (GitHub)
    needs: build-test
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-24.04
    # Релиз идёт в 'prod' (можно включить reviewers/таймер в UI)
    environment: prod
    permissions:
      contents: write

    steps:
      - name: Download packaged plugin
        uses: actions/download-artifact@v4
        with:
          name: poiskmore_plugin
          path: dist

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/poiskmore_plugin.zip
